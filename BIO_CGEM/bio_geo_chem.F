!=======================================================================
!  CGEM-FVCOM bio-geo-chem subroutine
!=======================================================================
SUBROUTINE bio_geo_chem(B_N,T_B,S_B,IRRAD)
!call bio_geo_chem(BIO_VAR,T_BIO,S_BIO,IRRAD0)
!------------------------------------------------------------------------------
!Input: bio variables(column), temperature(column),
!           surface irradiance(cell), and windspeed(cell)
!Output: new bio variables

!FVCOM  Define global data.
USE mod_1d, only: T_STEP,DELTA_D,DEPTH_Z
use schism_glbl, only: rkind
use cgem, only: ws,skipcgem,checkwindrad,sinkwcgem,nf,debug,Which_rad,Which_wind,&
                  PARfac,cgemcoords,cgemlat,cgemlon
use grid, only: iYrS,START_SECONDS,km

!Definitions from other subroutines
!mod_bio_3D.F:        DELTA_D(K)=DZ(I,K)*D(I)                   !LAYER THICKNESS
!
IMPLICIT NONE

!GOMDOM
!INTEGER*8, INTENT(IN) :: TC_8
REAL(rkind), INTENT(IN) :: IRRAD
REAL(rkind), INTENT(IN) :: T_B(km),S_B(km)
REAL(rkind), INTENT(INOUT) :: B_N(km,nf)
real(rkind) :: ff(nf),ff_new(nf),ff_in(km,nf),ff_out(km,nf),dz(km),PAR(km)
real(rkind) :: cgem_wind,cgem_dz
integer k, i, myrank,nz
logical :: is_surface,is_bottom
integer :: TC_8
real :: x
real(rkind) :: Rad, S
real(rkind), parameter :: cv        = 2.77e14_rkind ! multiplicative factor used
                                             ! to convert from watts/m2 
                                             ! to photons/cm2/sec
                                             ! Morel and Smith (1974)
real(rkind) dt,Wind
Wind=5
dt=1
i = 1
myrank = 1
S = 0
nz=km

  !Time in seconds since start of run
  TC_8 = START_SECONDS + T_STEP*int(dt)

    if(Which_rad.eq.1) then
      !Convert Rad from W/m2 to photons/cm2/sec
      Rad = IRRAD*cv
      !write(6,*) "RAD,IRRAD",Rad,IRRAD
    else
      call getSolar( iYrS, TC_8, cgemlon, cgemlat, Rad)
      ! Rad is just above sea surface.
      ! Rad was short wave generated by NRL, multiplied by SWtoPAR: ratio of PAR to
      ! shortwave radiation (hardcoded 4/30/14 to 0.43).
      ! Hardcoded to 0.47 on 2/11/16, Re: Tsubo and Walker, 2005
      ! PARfac is a multiplication factor for testing
      Rad = (0.47*Rad) * PARfac
    endif

    if(Which_wind.eq.1) then
      cgem_wind=Wind
    else
      !Set as constant if no wind fluxes available
      cgem_wind = 5.d0
    endif

!L3 Check these!!!
!         DELTA_D(K)=DZ(I,K)*D(I)                   !LAYER THICKNESS
!         DELTA_Z(K)=DZZ(I,K)*D(I)                  !DISTANCE BETWEEN LAYERS
!         DEPTH_Z(K)=Z(I,K)*D(I)                    !LAYER CENTER DEPTH

     call call_iop_par(ff_in,nz,TC_8,Rad,DELTA_D,cgemlat,cgemlon,PAR)

     do k=1,km
       is_surface = .FALSE.
       is_bottom = .FALSE.
       !check these...does FVCOM always have equal layers?
       if(k.eq.1) is_surface = .TRUE.
       if(k.eq.nz) is_bottom = .TRUE.
       call cgem_step(ff,ff_new,dT, S, T_B(k), PAR(k), cgem_wind, cgemlat, DELTA_D(k), DEPTH_Z(k), is_surface, is_bottom, Rad, i)
       do i=1,nf
         if(ws(i).gt.tiny(x)) then
          !sink
          call cgem_sink(ff(i),ff_new(i),ws(i),km,DELTA_D,dt,i,T_STEP,myrank)
         endif
       enddo
     enddo

!-----------------------------------------------------------------------------
RETURN

END SUBROUTINE bio_geo_chem
